<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title></title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <base href="../">

        <link rel="stylesheet" href="book.css">
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">

        <!-- MathJax -->
        <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Fetch JQuery from CDN but have a local fallback -->
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>
            if (typeof jQuery == 'undefined') {
                document.write(unescape("%3Cscript src='jquery.js'%3E%3C/script%3E"));
            }
        </script>
    </head>
    <body class="light">
        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme = localStorage.getItem('theme');
            if (theme == null) { theme = 'light'; }
            $('body').removeClass().addClass(theme);
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = localStorage.getItem('sidebar');
            if (sidebar === "hidden") { $("html").addClass("sidebar-hidden") }
            else if (sidebar === "visible") { $("html").addClass("sidebar-visible") }
        </script>

        <div id="sidebar" class="sidebar">
            <ul class="chapter"><li><a href="./using-the-wiki.html"><strong>1.</strong> Using this Document</a></li><li><a href="./new-projects.html"><strong>2.</strong> Checklist For New Projects</a></li><li><a href="./JavaScript/javascript.html"><strong>3.</strong> JavaScript</a></li><li><a href="./docker-images.html"><strong>4.</strong> Docker</a></li><li><a href="./Python/index.html"><strong>5.</strong> Python</a></li><li><ul class="section"><li><a href="./Python/sqlalchemy.html"><strong>5.1.</strong> SqlAlchemy</a></li></ul></li><li><a href="./basic-server-setup.html"><strong>6.</strong> Basic Server Setup</a></li><li><a href="./Rust/index.html"><strong>7.</strong> Rust</a></li><li><ul class="section"><li><a href="./Rust/rust_interop.html" class="active"><strong>7.1.</strong> Using Rust outside Rust</a></li><li><a href="./Rust/emails_and_templates.html"><strong>7.2.</strong> Emails and Templates</a></li><li><a href="./Rust/best_practices.html"><strong>7.3.</strong> Best Practices</a></li></ul></li><li><a href="./testing_in_c.html"><strong>8.</strong> Testing In C</a></li><li><a href="./latex.html"><strong>9.</strong> LaTeX Snippets</a></li></ul>
        </div>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar" class="menu-bar">
                    <div class="left-buttons">
                        <i id="sidebar-toggle" class="fa fa-bars"></i>
                        <i id="theme-toggle" class="fa fa-paint-brush"></i>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <i id="print-button" class="fa fa-print" title="Print this book"></i>
                    </div>
                </div>

                <div id="content" class="content">
                    <h1>Using Rust outside Rust</h1>
<p>Say you've got a bunch of really fast Rust code (remember, Rust is about the
same as C, sometimes faster) and want to call it from a slower language like
Python or Ruby, it's actually pretty easy to do. If you can run C code, you
can also run Rust.</p>
<h2>Quick Links</h2>
<p>For those too lazy to scroll:</p>
<ul>
<li><a href="Rust/rust_interop.html#Original%20Function">Original Function</a></li>
<li><a href="Rust/rust_interop.html#C">C</a></li>
<li><a href="Rust/rust_interop.html#Lua">Lua</a></li>
<li><a href="Rust/rust_interop.html#Python">Python</a></li>
<li><a href="Rust/rust_interop.html#Golang">Golang</a></li>
</ul>
<h2>Original Function</h2>
<p>We're going to make a contrived example to check if a number is prime.</p>
<pre><code class="language-bash">$ cat prime.rs
</code></pre>
<pre><code class="language-rust">#![feature(inclusive_range_syntax)]
#![feature(step_by)]

pub fn is_prime(n: u64) -&gt; bool {
    match n {
        0 | 1 =&gt; false,
        2 | 3 =&gt; true,
        n if n &amp; 1 == 0 =&gt; false,   // even numbers
        n =&gt; {
            let limit = (n as f64).sqrt() as u64 + 1;
            for i in (4...limit).step_by(2) {
                if n % i == 0 {
                    return false;
                }
            }
            return true;
        }
    }
}
</code></pre>
<p>You need to explicitly tell the rust compiler not to mangle the function
name, and export it as a C function. So the function signature needs to be
changed a bit...</p>
<pre><code class="language-rust">#[no_mangle]
pub extern &quot;C&quot; fn is_prime(n: u64) -&gt; bool {
...
}
</code></pre>
<p>And to make sure our library is callable from other code, it needs to be
compiled as a <code>cdylib</code> (with optimisations, of course).</p>
<pre><code class="language-bash">$ rustc prime.rs -O --crate-type cdylib
$ ls
prime.rs  libprime.so
</code></pre>
<p>Aaaannnnddd we're done. How easy was that?</p>
<p>Because the library hasn't been installed into one of the standard locations
(i.e. <code>/usr/lib/</code>), you'll also need to add an environment variable so things
know where to find it. You'd need to do the exact same with a C/C++ library
as well.</p>
<pre><code class="language-bash">$ export LD_LIBRARY_PATH=.
</code></pre>
<h1>C</h1>
<p>Considering almost everything is descended from C and can interoperate with C,
it makes sense to check out C first. In this case, calling Rust code from C is
just like calling code from another library. Even easier if you take into
account that you don't even need to write a header file.</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;

extern int is_prime(unsigned int n);

int main() {
  unsigned int n = 1234567;

  printf(&quot;%d %s prime\n&quot;, n, is_prime(n) ? &quot;is&quot; : &quot;is not&quot;);
  return 0;
}
</code></pre>
<p>And you link in the Rust library just like any other compiled <code>DLL</code> or <code>*.so</code>
file:</p>
<pre><code class="language-bash">$ gcc main.c -L. -lprime
</code></pre>
<blockquote>
<p><strong>Note:</strong> because of a compiler bug at the time and the std library isn't
being used directly, it isn't linked in when <code>rustc</code> creates our shared
object. Unfortunately, a couple things were indirectly needed from the std
library so I was getting linker errors later on. The fix was to add a dummy
function which uses something from the std library (e.g. a print statement).</p>
</blockquote>
<h2>Lua</h2>
<p>Next is calling our <code>Rust</code> code from <code>Lua</code>. <code>Lua</code> is a super light-weight
language (about 10,000 lines of C)  often used for embedding into applications
to make them scriptable. It's also one of the fastest scripting languages
in use at the moment.</p>
<p>Here's the script I'm using:</p>
<pre><code class="language-Lua">ffi = require(&quot;ffi&quot;)

ffi.cdef[[
int is_prime(unsigned int n);
]]

rust_lib = ffi.load(&quot;./libprime.so&quot;)

n = 1234567

if rust_lib.is_prime(n) then
  print(n, &quot;is prime&quot;)
else
  print(n, &quot;is not prime&quot;)
end
</code></pre>
<pre><code class="language-bash">$ luajit main.lua
1234567 is prime
</code></pre>
<p>That was easy enough, all you need to do is <code>load()</code> the <code>*.so</code> file and use
it like pretty much any other library in <code>Lua</code>.</p>
<h2>Python</h2>
<p>Next up is <code>Python</code>, unlike Lua, Python is well known for being slow.
Particularly when it comes to computationally expensive programs.</p>
<p>Python's standard library comes with a useful module for working with C (or
any other compiled language) called <code>ctypes</code>. You can use this pretty much the
same way as in Lua by creating some sort of object out of the loaded <code>*.so</code>
file and then calling it like normal.</p>
<pre><code class="language-python">import ctypes

primes = ctypes.CDLL('./libprime.so')

n = 1234567

if primes.is_prime(n):
    print(n, &quot;is prime&quot;)
else:
    print(n, &quot;is not a prime&quot;)
</code></pre>
<p>Python also has a really nice library called <code>cffi</code>. With <code>ctypes</code> you usually
need to define each function, its input arguments, and what it returns in order
to have type safety, but <code>cffi</code> uses a completely different approach. You just
pass it the text for a typical C header file and it does the rest. For larger
projects, or things which may still be evolving, <code>cffi</code> is a much nicer library
to use.</p>
<pre><code class="language-python">from cffi import FFI

ffi = FFI()

# Load a header entry for the Rust function
ffi.cdef(&quot;bool is_prime(int n);&quot;)
lib = ffi.dlopen(&quot;./libprime.so&quot;)

n = 1234567

if lib.is_prime(n):
    print(n, &quot;is prime&quot;)
else:
    print(n, &quot;is not a prime&quot;)

# trying to use an invalid datatype should fail
lib.is_prime(&quot;foo&quot;)
</code></pre>
<h2>Golang</h2>
<p>Another language I've been interested in lately is <a href="https://golang.org">Go</a>.
It's a compiled, statically typed, gabage collected language developed by the
guys at Google and primarily oriented towards networks, concurrency, and
microservices.</p>
<p>Go has a nice trick for allowing you to interact with C code. It's got special
behaviour when you do <code>import &quot;C&quot;</code>. Any comments above are passed to the
underlying compiler, meaning you can <code># include</code> any C library just like you
would in native C. Then, using reflection and other forms of black magic, you're
able to call anything in the imported namespace as an element of the <code>C</code> object.
i.e. calling <code>printf()</code> is just a case of doing <code>C.printf(...)</code>.</p>
<pre><code class="language-go">package main

/*
#cgo LDFLAGS: -L. -lprime
#include &quot;./prime.h&quot;
*/
import &quot;C&quot;
import &quot;fmt&quot;

func main() {
    var n C.uint = 1234567
    if C.is_prime(n) != 0 {
        fmt.Printf(&quot;%d is prime\n&quot;, n)
    } else {
        fmt.Printf(&quot;%d is not prime\n&quot;, n)
    }
}
</code></pre>

                </div>

                <!-- Mobile navigation buttons -->
                
                    <a href="./Rust/index.html" class="mobile-nav-chapters previous">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="./Rust/emails_and_templates.html" class="mobile-nav-chapters next">
                        <i class="fa fa-angle-right"></i>
                    </a>
                

            </div>

            
                <a href="./Rust/index.html" class="nav-chapters previous" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-left"></i>
                </a>
            

            
                <a href="./Rust/emails_and_templates.html" class="nav-chapters next" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-right"></i>
                </a>
            

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if ($(".fa").css("font-family") !== "FontAwesome") {
                $('<link rel="stylesheet" type="text/css" href="_FontAwesome/css/font-awesome.css">').prependTo('head');
            }
        </script>

        <!-- Livereload script (if served using the cli tool) -->
        

        <script src="highlight.js"></script>
        <script src="book.js"></script>
    </body>
</html>
